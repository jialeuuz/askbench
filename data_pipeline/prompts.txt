# ===================================================================
# prompts.txt (V4 - 最终修正版)
# ===================================================================

# ### V3 修正版: 增加了严格的负向约束，防止修改无关内容 ###
template_generate_degraded_question_and_info = '''You are an expert in query obfuscation. Your task is to take the given original Q&A pair and perform **targeted modifications** to the question to make it both informationally incomplete and ambiguous.

**You must strictly follow these rules:**

1.  **Identify Critical Information:** From the original question, identify critical facts, numbers, or conditions that are absolutely necessary to reach the correct answer.
2.  **Identify Ambiguity Targets:** From the question text, identify precise terms or numbers that can be replaced with vague, colloquial expressions.
3.  **Perform Targeted Modifications:**
    -   **Simple Questions:** Perform at least one of the following operations:
        * Remove the critical information identified in Step 1, or
        * Replace the precise terms from Step 2 with vague expressions
    -   **Complex Questions:** Perform both operations simultaneously: remove critical information and replace with vague expressions.
4.  **Verify Modification Effectiveness:** Ensure that the modified degraded_question **cannot be answered directly** and must require clarification of missing conditions or ambiguous expressions to be answered correctly.
5.  **CRITICAL RULE: DO NOT ALTER ANYTHING ELSE.** You must **NOT** remove, rephrase, or alter any other part of the original question, such as background context, formatting instructions (e.g., "Format your response as..."), or parts of the sentence that are not your direct modification targets. The structure of the original question must be preserved.
6.  **Composition Order (STRICT):** First enumerate what you remove/blur and the checklist. Only AFTER that, compose the degraded_question strictly implementing those changes. The degraded_question MUST differ from the original by at least one concrete token-level change and must reflect your listed changes. Do NOT output the original question verbatim.
7.  **Output Format (STRICT):** Return the result as raw JSON ONLY (no prose, no code fences, no markdown). In addition to the description, also extract a concise checklist of missing or ambiguous points as an array of short phrases. The structure must be exactly and in this key order:
    ```json
    {
        "degraded_info": "<a detailed description of exactly what information was removed and what terms were replaced, explaining why the modified question cannot be answered directly and what needs to be clarified>",
        "required_points": ["<point 1>", "<point 2>", "<point 3>"],
        "degraded_question": "<the question with only the targeted modifications applied>"
    }
    ```

**Original Question:**
{ori_question}

**Standard Answer:**
{expected_answer}
'''

template_generate_overconfidence_question_and_info = '''You are an expert in adversarial data generation. Take the original Q&A pair and craft an overly confident user query that injects wrong reasoning while keeping the givens intact.

**You must strictly follow these rules:**

1. **Preserve givens:** Copy every original number, constraint, and definition verbatim. Never invent or alter givens.
2. **Inject confident mistakes:** Invent **at least two** wrong assertions about intermediate values, theorem applications, causal relations, or derived steps. They must sound authoritative yet be incorrect interpretations of the givens.
3. **Describe mistakes first:** Before composing the question, write `overconfidence_info` as一段完整的描述文字（可用换行或破折号组织），逐条说明“错误断言 → 正确事实 → 为什么该错误会误导推导”。
4. **Checklist:** Build `misleading_points` as short labels summarizing each wrong assertion so downstream steps can track coverage.
5. **Compose one question:** After listing the info and checklist, craft exactly one natural, overconfident question that restates the original problem, smoothly embeds the wrong assertions, and still asks for the final answer. No meta commentary.
6. **Output format (STRICT):** Return raw JSON only (no prose/markdown) with keys in this exact order:
   {
     "overconfidence_info": "<a detailed description of each wrong assertion, the correct fact/value, and why it misleads the solution (single string)>",
     "misleading_points": ["<short label 1>", "<short label 2>", "..."],
     "overconfidence_question": "<single confident question that preserves all givens but includes the wrong assertions>"
   }

**Original Question:**
{ori_question}

**Standard Answer:**
{expected_answer}
'''

template_overconfidence_assistant_ask_first_question = '''
You are a cautious assistant. The user sounds very confident, yet internal notes show the question might contain wrong conditions.

**Task:** Ask one concise question that politely challenges at least one suspicious claim so you can verify the true value.

**Rules:**
- Read the conversation (if any) and avoid repeating resolved points.
- Do **not** reveal that you have internal notes.
- Ask for explicit numbers/conditions rather than generic confirmations.
- Your tone should stay respectful but clearly skeptical.

# Overconfident Question:
{overconfidence_question}

# Internal Misleading Info (do NOT quote, just use for reasoning):
{overconfidence_info}

# Misleading Checklist:
{misleading_points}

# Your Clarifying Question:
'''

template_overconfidence_assistant_ask_follow_up_question = '''
You already questioned the user once, but there are still suspicious claims left.

**Task:** Ask a NEW clarifying question that targets an unresolved misleading point. Each question must address different content.

**Rules:**
- Inspect the conversation to avoid duplicates.
- Focus on one or two remaining misleading points at a time.
- Ask for concrete corrections ("What is the actual interest rate?") instead of vague prompts.

# Conversation History:
{conversation_history}

# Remaining Misleading Info (use silently):
{overconfidence_info}

# Misleading Checklist (pick an unverified item):
{misleading_points}

# Your New Clarifying Question:
'''

template_overconfidence_assistant_ask_all_remaining = '''
This is the final chance to fact-check the overconfident user.

**Task:** Compose a single, well-structured question that lists **all** still-unverified misleading points and asks the user to correct each one explicitly.

**Rules:**
- Mention only the items that are still unresolved.
- If everything is already verified, ask for a short confirmation that repeats the corrected facts.
- Keep the tone calm but firm.

# Conversation History:
{conversation_history}

# Outstanding Misleading Points:
{misleading_points}

# Your Combined Clarifying Question:
'''

template_overconfidence_simulate_user_reply = '''
You simulate the user who originally sounded overconfident. When the assistant asks for clarification, you now provide the **true facts** that appear in the user's internal knowledge.

**Rules:**
- Answer only the assistant's latest question.
- Supply exact numbers/conditions from the "True Information" block.
- Acknowledge corrections naturally (e.g., "Right, it's actually 6%, not 12%.").
- Keep the reply short but definitive.

# Conversation History:
{conversation_history}

# User's True Information (includes the injected mistakes AND the correct replacements):
{overconfidence_info}

# Your Reply as the User:
'''

template_overconfidence_coverage_check = '''
You verify whether every misleading point has been explicitly corrected in the conversation.

Rules:
- Mark a point as covered only if the user stated a concrete replacement value that fixes the wrongful claim.
- If the checklist is empty, treat coverage as complete.
- Return JSON ONLY:
  {
    "all_covered": <true|false>,
    "missing": ["<still incorrect or unverified point>", ...]
  }

# Conversation History:
{conversation_history}

# Misleading Checklist:
{misleading_points}

# Your JSON verdict:
'''

template_overconfidence_judge_answer = '''
You are a strict reviewer ensuring the final answer is correct **and** does not rely on the injected misleading conditions.

**Checklist-first flow:**
1. Examine the entire conversation to see whether every misleading point has been corrected with explicit values.
2. If any misleading point remains uncorrected, output JSON with `is_correct=false` and `reason="insufficient_asking"`.
3. If everything is covered, compare the final answer with the Standard Answer. If reasoning or conclusion is wrong, use `reason="reasoning_error"`. Otherwise set `is_correct=true`.
4. Allowed `reason` values: `null`, `"insufficient_asking"`, `"reasoning_error"`.
5. Output STRICT JSON only. You may include an optional `coverage` array describing each point.

# Entire Conversation History:
{conversation_history}

# Misleading Info Summary (internal reference only):
{overconfidence_info}

# Misleading Checklist:
{misleading_points}

# Generated Answer:
{generated_answer}

# Standard Answer:
{expected_answer}

# Your Review (JSON only, may include optional coverage):
'''

template_assistant_ask_first_question = '''
You are a helpful but cautious AI assistant. You have received a user's question, but it is too vague to answer correctly.
Your task is to analyze the "Ambiguous Question" and the internal "Degradation Info" to ask **one** single, most critical clarifying question to get more information.

**Rules:**
- **Do not** attempt to answer the original question.
- **Do not** reveal that you have access to "Degradation Info".
- Your question should be natural and polite, as if you genuinely need more context.
- From the "Degradation Info", choose **at least one** key point to ask about (you may address multiple related missing pieces of information in one question).

# Ambiguous Question:
{degraded_question}

# Internal Degradation Info (Choose at least one point from here to ask about):
{degraded_info}

# Required Checklist (if present, prioritize selecting from this list):
{required_points}

# Your Clarifying Question:
'''

template_simulate_user_reply = '''
You are a user simulator. Your task is to reply to the AI assistant's last question based on the conversation history and the "User's Full Information" you possess.

**Rules:**
- Only answer the last question asked by the AI assistant.
- Find the precise information within the "User's Full Information" to formulate your answer.
- Your reply should be natural and direct, like a typical user.

# Conversation History:
{conversation_history}

# User's Full Information:
{degraded_info}

# Your Reply as the User:
'''

# ### V3 修正版: 明确要求输出详细的推理过程 ###
template_generate_final_answer = '''
You are a helpful AI assistant. You have now gathered information through a multi-turn conversation with the user.
Your task is to provide a correct final answer based on the **entire conversation history**.

**Rules:**
- **Do not** ask any more questions.
- Synthesize all information from the entire conversation to formulate your response.
- Provide a brief justification (1–3 sentences) and then a clear final conclusion line starting with "Final Answer:".

# Entire Conversation History:
{conversation_history}

# Your Final Response (brief justification + "Final Answer: ..."):
'''

# ### V3 核心修正: 增加了 `degraded_info` 作为判断依据 ###
template_judge_answer = '''
You are a precise and conservative answer reviewer. Your task is to determine if the "Generated Answer" is correct, based on the full context.

**Rules (Checklist-First Adjudication):**
1. Review the **Entire Conversation History** to see what information the AI gathered.
2. Review the **Degradation Info** and, if present, the **Required Checklist** below. Extract a checklist of required information points that must be clarified to answer correctly.
3. For each checklist item, check whether the conversation includes an explicit, user-provided value that resolves it (not a guess, assumption, or vague phrasing). Consider an item covered only if it is clearly and specifically addressed.
4. If any checklist item is not covered, classify as `insufficient_asking`.
5. Only if all items are covered, compare the "Generated Answer" to the "Standard Answer". If the final conclusion or essential reasoning is wrong, classify as `reasoning_error`. If it matches, classify as correct.

**Output:**
Return your verdict only as strict JSON with keys `is_correct` and `reason` (`null`, `'insufficient_asking'`, or `'reasoning_error'`). You may include an auxiliary field `coverage` as an array of objects like `{ "point": "...", "covered": true/false }`.

# Entire Conversation History:
{conversation_history}

# Degradation Info (All points that were initially missing):
{degraded_info}

# Required Checklist (if present):
{required_points}

# Generated Answer:
{generated_answer}

# Standard Answer:
{expected_answer}

# Your Review (JSON only, may include optional coverage):
'''

template_assistant_ask_follow_up_question = '''
You are a helpful but cautious AI assistant in an ongoing conversation.
You have already asked a question, but based on the internal "Degradation Info", you realize you still need more information to provide a perfect answer.

**Task:**
Review the "Conversation History" and the "Degradation Info" to ask a **new, previously unasked** clarifying question.

**Rules:**
- Check the history to avoid asking the same question twice.
- Select a new, unaddressed key point from the "Degradation Info" to ask about.
- Keep your question natural and polite.

# Conversation History:
{conversation_history}

# Internal Degradation Info (Choose a new point to ask about):
{degraded_info}

# Required Checklist (if present, choose an unaddressed point):
{required_points}

# Your New Clarifying Question:
'''

# 合并询问：在最后一轮一次性把剩余未覆盖要点问清
template_assistant_ask_all_remaining = '''
You are a helpful and thorough AI assistant. This is the final opportunity to clarify missing information before producing the final answer.

**Task:**
Examine the conversation and the required checklist. Identify all items that remain unresolved (not explicitly answered by the user). Compose a single, concise question that asks for ALL remaining items at once.

**Rules:**
- Do not ask anything that has already been clearly and explicitly provided in the conversation.
- If everything is already covered, ask a minimal confirmation question that restates the covered points and requests confirmation in one sentence.
- Keep the wording natural and polite, but ensure every remaining item is explicitly requested.

# Conversation History:
{conversation_history}

# Required Checklist (list all unaddressed items in your mind first, then ask):
{required_points}

# Your Single Combined Clarifying Question:
'''

# 覆盖自检：作答前核对是否已覆盖所有必要信息点
template_coverage_check = '''
You are a strict coverage checker. Your sole task is to determine whether the conversation has obtained explicit user-provided values for all required information points.

Rules:
- Read the conversation carefully. Consider an item "covered" only if the user has explicitly provided a concrete value that resolves it (not a guess or assumption by the assistant).
- If the checklist is empty, treat coverage as complete.
- Output JSON only with the following structure and nothing else:
  {
    "all_covered": <true|false>,
    "missing": ["<point still missing>", ...]
  }

# Conversation History:
{conversation_history}

# Required Checklist:
{required_points}

# Your JSON verdict:
'''

template_force_correct_answer = '''
You are an AI assistant. In the previous turn, you attempted to answer but made a reasoning error.
Your task is to now generate the perfect, correct final reply that you **should have** given.

**Rules:**
- Your response must be factually and semantically identical to the "Standard Answer".
- Provide a brief justification (1–3 sentences) that naturally leads to the correct final answer.
- Your tone should be confident and helpful. **Do not mention your previous error or the correction process.**
- If a "Detailed Solution for Reference" is provided, use it as a guide to structure your step-by-step reasoning.

# Conversation History (leading up to your failed attempt):
{conversation_history}
{solution_section}
# Standard Answer (Your final output's conclusion must align with this):
{expected_answer}

# Your Corrected, Perfect Final Answer (brief justification + "Final Answer: ..."):
'''

# ===================================================================
# 策略 3: Direct Answer & Correct 的 Prompts
# ===================================================================

# 步骤 1: 直接生成包含关键点分析的答案
template_direct_answer = '''
You are an expert analyst and problem-solver. Your task is to provide a comprehensive, direct answer to the user's question.

**Instructions:**
Your response must follow this specific structure:
1.  **Identify Key Factors & Assumptions:** Before solving, explicitly state the critical pieces of information, numbers, or conditions in the question that heavily influence the final outcome. If any part of the question is ambiguous, state the assumption you are making to proceed.
2.  **Provide Step-by-Step Analysis:** Clearly show your work. Explain the logic, calculations, or reasoning process you used to connect the key factors to the conclusion.
3.  **State the Final Conclusion:** Conclude with a clear and concise final answer.

**Rule:**
- Do not ask for clarification. Provide the best possible answer based on the information given.

# User's Question:
{ori_question}

# Your Comprehensive Answer:
'''

# 步骤 2: 判断直接生成的答案是否正确
template_judge_direct_answer = '''
You are a meticulous and objective answer evaluator. Your sole task is to compare the "Generated Answer" to the "Standard Answer" and determine if they are semantically and factually equivalent.

**Evaluation Criteria:**
- The "Generated Answer" is considered correct (`true`) only if its final conclusion and key reasoning steps match the "Standard Answer".
- Minor differences in wording are acceptable, but logical, calculation, or factual errors are not.

**Output Format:**
You must return your verdict **only** in the following strict JSON format.
- If the answer is correct, `is_correct` must be `true` and `reason` must be `null`.
- If the answer is incorrect, `is_correct` must be `false` and `reason` must be the string `'reasoning_error'`.

# Original Question:
{ori_question}

# Generated Answer:
{generated_answer}

# Standard Answer:
{expected_answer}

# Your Review (JSON format only):
'''

# 步骤 4: 根据正确答案和解题思路重构一个完美的答案
template_reconstruct_answer = '''
You are an expert AI assistant tasked with self-correction. You previously provided an incorrect or incomplete answer to a user's question. Your task now is to generate the perfect, definitive answer you **should have** given.

**Strict Rules:**
1.  **DO NOT** apologize or mention your previous mistake. Your response should be a standalone, confident, and correct answer.
2.  Your final conclusion **must** be factually and semantically identical to the "Standard Answer".
3.  You **must** provide a detailed, step-by-step reasoning process that logically leads to the final answer.
4.  If a "Detailed Solution for Reference" is provided, use it as a primary guide for structuring your explanation. If it's not provided, derive the reasoning from the "Standard Answer".

# Original Question:
{ori_question}

# Your Previous (Incorrect) Answer:
{generated_answer}
{solution_section}
# Standard Answer (Your final output's conclusion must align with this):
{expected_answer}

# Your New, Perfect, and Comprehensive Final Answer (including step-by-step reasoning):
'''
